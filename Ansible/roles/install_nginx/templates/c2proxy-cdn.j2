geo $allow_azure { 
    default 1;
    include ./geoip/azure_cdn.conf;
}

server {
    listen 80;
    server_name {{ server_domain }};
    return 301 https://{{ server_domain }}$request_uri;
}

server {
 listen 443 ssl;
 http2 on;
 server_tokens off;
 server_name {{ server_domain }};
 ssl_protocols TLSv1.2; #TLSv1.3;
 ssl_prefer_server_ciphers on; 
 ssl_dhparam /etc/ssl/certs/dhparam.pem;
 ssl_ciphers EECDH+AESGCM:EDH+AESGCM;
 ssl_ecdh_curve secp384r1;
 ssl_session_timeout 10m;
 ssl_session_cache shared:SSL:10m;
 ssl_session_tickets off;
 ssl_stapling on;
 ssl_stapling_verify on;
 ssl_certificate /etc/letsencrypt/live/{{ server_domain }}/fullchain.pem; 
 ssl_certificate_key /etc/letsencrypt/live/{{ server_domain }}/privkey.pem;
 add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";
 add_header X-Frame-Options DENY;
 add_header X-Content-Type-Options nosniff;
 add_header X-XSS-Protection "1; mode=block";
 access_log /var/log/nginx/access.log combined;
 error_log  /var/log/nginx/error.log error;

 if ($allow_azure = 1) {
        return 301 {{ redir_target }};
 }

 if ($host !~ "^({{ server_domain }})$") {
        return 301 {{ redir_target }};
 }

 location / {
    proxy_pass {{ c2_ip_address }};
    proxy_ssl_verify off;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
   }
}
